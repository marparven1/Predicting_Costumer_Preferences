---
title: "Proyecto Blackwell Electronics. Data Science Process"
subtitle: "Módulo 3 Tarea 3: Regresión múltiple. Análisis de predicción de ventas"
author: "Marta Venegas Pardo"
date: "30/Noviembre/2021"
output:
  prettydoc::html_pretty:
    theme: leonids
    highlight: github
    toc: yes
    toc_depth: 5
    number_sections: yes
lang: es
---

```{r setup, include=FALSE,message=FALSE,warning=FALSE}
knitr::opts_chunk$set(message=FALSE,warning=FALSE , echo = FALSE
  )
```

```{r librerías}
dire<-getwd() 
setwd(dire) 

# Librerías necesarias
library(dplyr)
library(kableExtra)
library(knitr)

# Gráficos
library(ggplot2)
library(scales)
## Matriz de correlación 
library(corrplot)
# Análisis exploratioro
library(SmartEDA)

# Modelado
library(caret)
```

# Introducción (definición del problema + objetivos)

## Objetivos

El equipo de ventas de Blackwell Electronics solicita que analicemos los datos correspondientes a las ventas de distintos productos con el **objetivo** de:

- Entender como las ventas varían en función del tipo de producto
- Predecir las ventas de cuatro tipos de productos diferentes: PC, portátiles, netbooks y teléfonos inteligentes
- Evaluar el impacto que tienen las revisiones de los servicios y las reseñas de los clientes en las ventas de diferentes tipos de productos


Para ello, analizaremos los datos correspondientes al histórico de ventas para hacer predicciones del volumen de ventas de los nuevos productos. 




## Qué encontraremos en este informe

- Descripción de los datos y variables predictoras de las ventas de cada producto
- Limpieza de datos y preparación para el modelado
- Análisis exploratorio, resumen de mis datos, representaciones gráficas,
- Modelado, prueba de diferentes modelos con diferentes hiperparametrizaciones, entrenamiento de los modelos con validación y testeo de los modelos
- Test final del mejor modelo y predicción del volumen de ventas de los nuevos productos en el conjunto de datos "new product" 
- Conclusiones



## Procedimiento para cumplir mis objetivos

-   Descripción de datos, pre-procesado, data cleaning y análisis exploratorio
-   Modelado a través de algoritmos de regresión , como por ejemplo:
-   Decisión del método que mejor funciona 
- Una vez tengamos el modelo final, predecir las ventas de los cuatro tipos de productos informáticos


# Descripción de los conjuntos de datos

-   Conjuntos de datos:

    -   **DatosProdExistentes**: Histórico de ventas con los 80 productos existentes, sus características y valoraciones
    -   **DatosProdNuevos**: Dataset con 24 nuevos productos, sus características y valoraciones

```{r}
DatosProdExistentes<-read.csv(file="DATOS/existingproductattributes2017.csv",header = TRUE,sep = ",",dec ="." )

DatosProdNuevos<-read.csv(file="DATOS/newproductattributes2017.csv",header = TRUE,sep = ",",dec =".")
```

Vamos a visualizar los datos:

```{r}
DatosProdExistentes %>% 
  head(10) %>% 
  kable(booktabs=TRUE,caption = "Histórico de ventas. Datos: Productos existentes") %>% 
  kable_styling(latex_options = "striped")
```

```{r}
DatosProdNuevos %>% 
  head(10) %>% 
  kable(booktabs=TRUE,caption = "Datos: Productos nuevos") %>% 
  kable_styling(latex_options = "striped")
```


```{r}
str(DatosProdNuevos)
```

```{r}
str(DatosProdExistentes)
```




## Descripción de variables

-   Datos de entrenamiento y validación: 80 productos diferentes
-   Datos de testeo: 24 productos diferentes

En ambos conjuntos de datos encontramos 18 variables :

-   **Product type**: Tipo de producto. Encontramos 12 tipos diferentes (Accesorios, monitor ordenador portatil, Netbook, impresora, extensión de la garantía, Consola, accesorios de impresora, teléfonos inteligentes, tabletas, software). (Variable categórica)

-   **ProductNum**: Identificador del producto, es único para cada producto (Variable numérica)

-   **XiStarReviews**: cinco variables correspondientes a las puntuaciones (i=1-5) al producto  (Variable numérica, que indica el número de veces que se le ha dado esa puntiación)

-   **PositiveServiceReview**: Número de veces que se ha dado una reseña positiva por el servicio. (numérica)
-   **NegativeServiceReview**: Número de veces que se ha dado una reseña negativa por el servicio. (numérica)
-   **RecommendProduct**: Puntuación entre 0 y 1 en función si recomendaría o no el producto (variable numérica)
-   **Best Seller Rank**: Puesto que ocupa en un ránking de productos  (variable numérica entera)
-   **Shipping Weigth**: Peso del envío (variable numérica)
-   **Product Depth**: Dimensiones de la profundidad del producto (variable numérica)
-   **Product Width**: Dimensiones del ancho del producto (variable numérica)
-   **Product Heigth**: Dimensiones del alto del producto (variable numérica)
-   **ProfitMargin**: Margen de beneficio que proporciona el producto (numérica)
-   **Target. Volume**: Volumen de ventas de dicho producto. (Variable numérica entera)



```{r}
#dim(DatosProdExistentes)
#dim(DatosProdNuevos)
```


# Preparación de los datos (Limpieza de datos)

En este paso del proceso, trataremos de encontrar, corregir o eliminar registros erróneos (incompletos) en nuestros datos. Para ello estudiaremos si todas las instancias están completas, si existen duplicados, valores atípicos,...

```{r}
str(DatosProdExistentes)
str(DatosProdNuevos)
summary(DatosProdExistentes)
summary(DatosProdNuevos)
```

## Duplicados


Mostramos a continuación, las instancias duplicadas en nuestros datasets:

-   Duplicados en los datos de entrenamiento:

```{r}
DatosProdExistentes[duplicated(DatosProdExistentes)==TRUE,]
```

-   Duplicados en los datos de testeo:

```{r}
DatosProdNuevos[duplicated(DatosProdNuevos)==TRUE,]
```

Por tanto, en nuestros conjuntos de datos, no existen instancias duplicadas.




## Datos ficticios (dummy)

Tenemos que transformar la variable product type de factor a variable binaria de (0 y 1)


```{r}
# dummy of the data
newDataFrame <- dummyVars(" ~ .", data = DatosProdExistentes)
readyData <- data.frame(predict(newDataFrame, newdata = DatosProdExistentes))

#boxplot(readyData[,-c(1,2,3,4,5,6,7,8,9,10,11,12)])


str(readyData)

```




## Datos faltantes

El conjunto de datos correspondientes al histórico de ventas tiene 15 productos en los que la columna BestSellerRank tiene un valor NA. Es decir, no conocemos la posición en el ranking de mejores vendidos de esos productos

```{r}
# summary(DatosProdExistentes$BestSellersRank)
# summary(DatosProdNuevos$BestSellersRank)
summary(readyData$BestSellersRank)
```

```{r}
DatosProdExistentes %>% 
  filter(
    is.na(BestSellersRank )
  ) %>% kable(booktabs=TRUE) %>% 
  kable_styling(latex_options = "striped")
```


Las opciones son las siguientes: imputar el valor que ocuparía en el ranking, eliminar esos registros (no debemos), eliminar esa columna del estudio. 

Opción elegida: eliminemos cualquier atributo que tenga datos faltante.

```{r}
DatosProdExistentes$attributeWithMissingData <- NULL
readyData$attributeWithMissingData <- NULL
```




## Outliers

-   En el dataset de entrenamiento *Datos de Productos existentes*, encontramos valores atípicos en bastantes variables (no estudio outliers de la variable ID, porque no tiene sentido)


```{r}
boxplot(DatosProdExistentes[,3:8],main="BoxPlot. Precio y calificación de los productos \n Datos del histórico de ventas")
# $out

boxplot(DatosProdExistentes[,9:10],main="BoxPlot. Reseña de los productos \n Datos Completos")

boxplot(DatosProdExistentes[,11],main="BoxPlot. Recommend product \n Datos Completos")

boxplot(DatosProdExistentes[,13:16],main="BoxPlot. Dimensiones del prducto \n Datos Completos")

boxplot(DatosProdExistentes[,18],main="BoxPlot. Volumen de ventas \n Datos Completos",
        xlab="Volumen de ventas")
```

## Transformación de variables

### Factorización de las variables

No es necesario

### Normalización de variables

No necesitamos normalizar las variables para que estén todas en la misma escala, ya la mayoría de variables son ordinales, y las que no lo son (peso, altura del producto,...) se encuentran todas en la misma escala.

```{r}
#scale(x,center = TRUE,scale = TRUE)
```


## Creación de variables

No necesario por el momento. Ya, con dummy data nuestro nuevo dataset _readydata_ contiene una nueva variable binaria para cada tipo de producto, con un uno si el producto es de ese tipo y un 0 si no lo es.






# Análisis exploratorio

```{r}
# Nota para mí: Describiré el DSP, recordando las preguntas de Danielle Sherman
```

Comenzaremos con un breve resumen estadístico de nuestros datos:

Dataset: Histórico de ventas


```{r}
summary(DatosProdExistentes$ProductType)
```





```{r}
summary(DatosProdNuevos)
```


```{r}
summary(readyData)
```


-   **Tipo de producto**: La mayoría de productos que existentes en blackwell eran accesorios, seguido de impresoras y extensiones de la garantía. Para los nuevos productos, la mayoría son smartphones o netbooks


-   **Precio**: El precio medio de los productos existentes en blackwell es de 247.25 euros (rango de 2249.99/3.60), mientras que el precio medio de los productos nuevos es bastante superior: 425.6 euros (rango:8.5/1999)




## Resumen según tipo de producto

```{r}
#DatosCompletosCategoricos %>% 
#  group_by(Marca) %>% 
#  summarise(
#  SalarioMedio = mean(salary)  ,
#  EdadMedia = age %>% mean() ,
#  CreditoMedio = credit %>% mean() ,
#) %>% kable(booktabs=TRUE, caption="Resumen estadístico según marca preferida \n #Variables Numéricas")
```


```{r}
#DatosMarca = DatosCompletosCategoricos %>% 
#  group_by(Marca) %>% 
#  count()
```



```{r}
#DatosMarca %>% 
#  mutate(
#    TOTAL = 3744+6154 ,
#    Frecuencia =round( 100*(n / TOTAL) , 2 )) %>% 
#  select(n,Frecuencia) %>% 
#  kable(booktabs=TRUE, caption="Resumen estadístico según marca preferida",col.names #= c("Marca","Número de clientes","Frecuencia"),align = "l")
```






## Representaciones gráficas

### Product type

Vamos a ver el número de productos de cada tipo existentes:

```{r}
# summary(DatosProdExistentes$ProductType)
NumeroProductos <- c(26,5 ,10 , 2 ,3,2,4,12,3,4,6,3)
TipoDeProducto<- DatosProdExistentes$ProductType %>% levels()


productosEx <- cbind.data.frame(TipoDeProducto,NumeroProductos) 

productosEx %>% 
  kable(booktabs=TRUE) %>% 
  kable_styling(latex_options = "striped")
```



```{r}
ggplot(data=productosEx, aes(x=reorder(TipoDeProducto,-NumeroProductos) , 
                                     y =NumeroProductos , fill= TipoDeProducto)) + 
    geom_bar(stat="identity", position="dodge")+
    scale_y_continuous(breaks = seq(1,28,by=2))+
      labs(title="Gráfico de barras" ,
         subtitle= "Tipo de producto y número de productos diferentes", 
         caption="Fuente: Elaboración propia. ")+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

En Blackwell electronics, encontraremos:

- 26 tipos de accesorios diferentes
- 12 artículos de tipo impresora
- 10 garantías diferentes
- 6 posibles softwares diferentes
- 5 pantallas de ordenador
- 4 tipos de smartphones distintos, al igual que ordenadores portátiles
- 2 tipos de notebook diferentes y dos consolas
- Encontramos 3 articulos de tipo tables y 3 accesorios para las impresoras




### Tipo de producto y volumen ventas (importes generados)



### Tipo de producto y volumen de ventas 

A continuación vamos a estudiar como ha sido el volumen de ventas en función del tipo de producto y el importe (en dólares) generado por cada tipo de producto.


```{r}
DatosVentas = DatosProdExistentes %>% group_by(ProductType) %>% 
  summarise(
    VolumenVentasTotal = sum(Volume),
    VolumenMedio = mean(Volume),
    ImporteVenta = sum(Volume*Price),
    MediaImporteVenta = mean(Volume*Price)
  )
DatosVentas %>% kable(booktabs=TRUE) %>% kable_styling(latex_options = "striped")
```


```{r}
ggplot(data=DatosVentas, aes(x=reorder(ProductType,-VolumenVentasTotal) , 
                                     y =VolumenVentasTotal , fill= ProductType)) + 
    geom_bar(stat="identity", position="dodge") +
   scale_y_continuous(breaks = seq(0,28000,by=5000))+
    labs(title="Gráfico de barras" ,
         subtitle= "Tipo de producto y volumen de venta histórico", 
         caption="Fuente: Elaboración propia. Conjunto de datos del histórico de ventas",
         xlab="Tipo de producto", ylab="Volumen de ventas histórico")+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```


En el gráfico de barras podemos ver como los accesiorios son el tipo de productos que más volumen de ventas ha generado en las tiendas de Blackwell a lo largo de los años, seguido de las extensiones de la garantías y los videojuegos.



```{r}
ggplot(data=DatosVentas, aes(x=reorder(ProductType,-VolumenMedio) , 
                                     y =VolumenMedio , fill= ProductType)) + 
    geom_bar(stat="identity", position="dodge") +
   scale_y_continuous(breaks = seq(0,5000,by=500))+
    labs(title="Gráfico de barras" ,
         subtitle= "Tipo de producto y volumen medio de ventas", 
         caption="Fuente: Elaboración propia. Conjunto de datos del histórico de ventas",
         xlab="Tipo de producto", ylab="Volumen de ventas histórico")+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

### Tipo de producto e importe generados 

A contuniación, veremos una tabla en la que tenemos expresado el precio total de las ventas generadas por cada tipo de producto, así como el valor medio, es decir, el precio medio de las ventas generadas de cada producto.


Vamos a representarlo gráficamente

```{r}
ggplot(data=DatosVentas, aes(x=reorder(ProductType,-ImporteVenta) , 
                                     y =ImporteVenta , fill= ProductType)) + 
    geom_bar(stat="identity", position="dodge") +
   scale_y_continuous(breaks = seq(0,1800000,by=80000))+
    labs(title="Gráfico de barras" ,
         subtitle= "Tipo de producto e importe total generado según ventas", 
         caption="Fuente: Elaboración propia. Conjunto de datos del histórico de ventas"
         )+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

```



```{r}
ggplot(data=DatosVentas, aes(x=reorder(ProductType,-MediaImporteVenta) , 
                                     y =MediaImporteVenta , fill= ProductType)) + 
    geom_bar(stat="identity", position="dodge") +
   scale_y_continuous(breaks = seq(0,800000,by=90000))+
    labs(title="Gráfico de barras" ,
         subtitle= "Tipo de producto e importe medio generado según ventas", 
         caption="Fuente: Elaboración propia. Conjunto de datos del histórico de ventas"
         )+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

```

Vemos, que el importe medio del volumen total de ventas de los juegos de consola es de 706413.5800 dólares. Es destacable que para accesorios, se han generado 42030.9815 euros de media, siendo éste el tipo de producto que más se ha vendido. Esto significa que se han realizado muchas ventas pero de un importe bajo.


## Grado de asociación de las variables



```{r}
M = cor(DatosProdExistentes[,-c(1,2,12)])
corrplot(M, method = "circle",title = "Matriz de correlación")

M =cor(readyData)
corrplot(M, method = "circle",title = "Matriz de correlación")

# Visualice otros metodos gráficos como, 'circle', 'square', 'ellipse',
# 'number', 'shade', 'color', 'pie',
```




























