---
title: "Proyecto Blackwell Electronics. Data Science Process"
subtitle: "Módulo 3 Tarea 2: Predicción de la marca preferida por los clientes"
author: "Marta Venegas Pardo"
date: "8/Noviembre/2021"
output:
  prettydoc::html_pretty:
    theme: leonids
    highlight: github
    toc: yes
    toc_depth: 5
    number_sections: yes
  pdf_document:
    toc: yes
    toc_depth: 5
    number_sections: yes
lang: es
---

```{r setup, include=FALSE,message=FALSE,warning=FALSE}
knitr::opts_chunk$set(message=FALSE,warning=FALSE , echo = FALSE
  )
```

```{r librerías}
dire<-getwd() 
setwd(dire) 

# Librerías necesarias
library(dplyr)
library(kableExtra)
library(knitr)
# Gráficos
library(ggplot2)
## Matriz de correlación 
library(corrplot)

#install.packages("caret", dependencies = c("Depends", "Suggests"))
library(C50)
library(caret)
library(mlbench)
```



# Introducción (definición del problema + objetivos)

## Objetivos

El equipo de ventas de Blackwell Electronics contrató una empresa de investigación de mercado para realizar una encuensta a los clientes con el siguiente **objetivo**:

-   Averiguar, de entre las marcas de ordenadores en venta, cual es la **marca preferida** por los clientes.

Con esta información, se podrán tomar decisiones sobre que fabricantes se debe buscar una relación estratégica mejor.

-   Sin embargo, como suele ocurrir al hacer una encuesta, las información sobre la preferencia de marcas de ordenador no quedó recogida por completo por lo que no tenemos resultados precisos.

-   Por ello debemos investigar si las respuestas a *otras preguntas* de la encuesta podrían ayudarnos a predecir la preferencia de marca de ordenador de nuestros clientes.

## Qué encontraremos en este informe

## Procedimiento para cumplir mis objetivos

-   Descripción de datos, pre-procesado, data cleaning y análisis exploratorio
-   Modelado a través de algoritmos de clasificacción (árboles de decisión), como p0r ejemplo C5.0 y RandomForest, entre otros
-   Decisión del método que mejor funciona para predecir la marca de ordenador preferida por los clientes

# Descripción de los datos

-   Conjuntos de datos:

    -   **CompleteResponses**: Conjunto de datos con 10000 encuestas completas que usaremos para entrenar el modelo y construir un modelo predictivo
    -   **Survey Incomplete**: Dataset para testear el mejor modelo y tratar de predecir la marca preferida por los clientes
    -   **Survey key**: Encuesta (al final del documento)

```{r}
DatosCompletos<-read.csv(file="SurveyData/CompleteResponses.csv",header = TRUE,sep = ",",dec ="." )

DatosIncompletos<-read.csv(file="SurveyData/SurveyIncomplete.csv",header = TRUE,sep = ",",dec =".")
```

Vamos a visualizar unas cuantas líneas de los datos:

```{r}
DatosCompletos %>% 
  head(10) %>% 
  kable(booktabs=TRUE,caption = "Datos Completos") %>% 
  kable_styling(latex_options = "striped")
```

```{r}
DatosIncompletos %>% 
  head(10) %>% 
  kable(booktabs=TRUE,caption = "Datos incompletos") %>% 
  kable_styling(latex_options = "striped")
```

## Variables

-   Datos de entrenamiento y validación: 9898 registros, 7 variables
-   Datos de testeo: 5000 registros con las mismas 7 variables

En los conjuntos de datos encontramos 7 variables :

-   **Salario**: Salario anual del cliente, en dólares. (Variable numérica)

-   **Edad**: Edad, en años (Variable numérica)

-   **Elevel**: Nivel educativo más alto alcanzado. (Variable categórica). Corresponde a una escala de Likert

    -   0: Less than High School Degree
    -   1: High School Degree
    -   2: Some College
    -   3: 4-Year College Degree
    -   4: Master's, Doctoral or Professional Degree

-   **Car**: Marca de coche del cliente (1-20) (Variable categórica). Ver codificación al final del coumento (en la encuesta)

-   **Zip**: Código postal. (categórica)

    -   0: New England
    -   1: Mid-Atlantic
    -   2: East North Central
    -   3: West North Central
    -   4: South Atlantic
    -   5: East South Central
    -   6: West South Central
    -   7: Mountain
    -   8: Pacific

-   **Credit**: Crédito total disponible (variable numérica)

-   **Target. Brand**: Marca de ordenador preferida. (Variable Binaria)

    -   0: Acer
    -   1: Sony

```{r}
# dim(DatosCompletos)
# dim(DatosInompletos)
```

# Preparación de los datos (Limpieza de datos)


En este paso del proceso, trataremos de encontrar, corregir o eliminar registros erróneos en nuestros datos. Para ello estudiaremos si todas las instancias están completas, si existen duplicados, valores atípicos,...


```{r}
str(DatosCompletos)
```

```{r}
str(DatosIncompletos)
```

```{r}
summary(DatosCompletos)
```

```{r}
summary(DatosIncompletos)
```

## Duplicados

Mostramos a continuación, las instancias duplicadas en nuestros datasets:

- Duplicados en los datos de entrenamiento:

```{r}
DatosCompletos[duplicated(DatosCompletos)==TRUE,]
```


- Duplicados en los datos de testeo:

```{r}
DatosCompletos[duplicated(DatosIncompletos)==TRUE,]
```


Por tanto, nn nuestros conjuntos de datos, no existen instancias duplicadas.

## Missing values


Ambos conjuntos de datos, estan completos.

```{r}
# summary(DatosCompletos)
# summary(DatosIncompletos)
# En caso de haber datos NA, lo veríamos aquí
```


## Outliers

- En el dataset de entrenamiento _Datos Completos_, no encontramos valores atípicos. 
- En el conjunto de datos de testeo _Datos Incompletos_, encontramos 63 valores atípicos en la variable Brand (target). Se han considerado a típicos porque es un conjunto de datos con 5000 registros, por lo que supone un `r (63*100)/5000` $\%$ del total de instancias de este conjunto de datos. Esto se debe a que en este conjunto de datos existe un error y no debería haber valores correspondientes a Brand = Sony. En este conjunto de datos, será la variable que vamos a predecir.


```{r}
#boxplot(DatosCompletos)$out 
#boxplot(DatosIncompletos)$out
```


## Transformación de variables

### Factorización de las variables

Recodificamos las variables categóricas:

-   Target: Brand
-   Código Postal
-   Car
-   Nivel educativo

```{r}
DatosCompletosCategoricos = DatosCompletos
DatosCompletosCategoricos = DatosCompletosCategoricos%>% 
  mutate(
    Marca = factor(DatosCompletosCategoricos$brand, 
                   levels = c(0,1), 
                   labels = c("Acer", "Sony")),
    CodigoPostal = factor(DatosCompletosCategoricos$zipcode,
                          levels = c(0,1,2,3,4,5,6,7,8), 
                          labels =   c("New England","Mid-Atlantic","East North Central","West North Central","South Atlantic","East South Central","West South Central","Mountain","Pacific")),
    NivelEduc = factor(DatosCompletosCategoricos$elevel, 
                   levels = c(0,1,2,3,4), 
                   labels = c("Less HS", "HS", "SomeCollege","College Degree","Post College Decree")),
    MarcaCoche= factor(DatosCompletosCategoricos$car, 
                   levels = 1:20, 
                   labels=c("BMW","Buick","Cadillac","Chevrolet","Chrysler","Dodge","Ford","Honda","Hyundai","Jeep","Kia","Lincoln","Mazda","Mercedes Benz","Mitsubishi","Nissan","Ram","Subaru","Toyota","Other")
))%>% 
  select(c(1,2,10,11,9,6,8))


DatosCompletosCategoricos %>% head(10) %>% 
  kable(booktabs=TRUE, caption="Conjunto de datos completo")




DatosIncompletosCategoricos = DatosIncompletos
DatosIncompletosCategoricos = DatosIncompletosCategoricos%>% 
  mutate(
    Marca = factor(DatosIncompletosCategoricos$brand, 
                   levels = c(0,1), 
                   labels = c("Acer", "Sony")),
    CódigoPostal = factor(DatosIncompletosCategoricos$zipcode,
                          levels = c(0,1,2,3,4,5,6,7,8), 
                          labels =   c("New England","Mid-Atlantic","East North Central","West North Central","South Atlantic","East South Central","West South Central","Mountain","Pacific")),
    NivelEduc = factor(DatosIncompletosCategoricos$elevel, 
                   levels = c(0,1,2,3,4), 
                   labels = c("Less HS", "HS", "SomeCollege","College Degree","Post College Decree")),
    MarcaCoche= factor(DatosIncompletosCategoricos$car, 
                   levels = 1:20, 
                   labels=c("BMW","Buick","Cadillac","Chevrolet","Chrysler","Dodge","Ford","Honda","Hyundai","Jeep","Kia","Lincoln","Mazda","Mercedes Benz","Mitsubishi","Nissan","Ram","Subaru","Toyota","Other")
))%>% 
  select(c(1,2,10,11,9,6,8))



DatosIncompletosCategoricos %>%
  head(10) %>% 
  kable(booktabs=TRUE, caption="Conjunto de datos incompleto")

```

## Creación de variables

De momento no es necesario.


# Análisis exploratorio


```{r}
# Nota para mí: Describiré el DSP, recordando las preguntas de Danielle Sherman
```

Comenzaremos con un breve resumen estadístico de nuestros datos:






```{r}
summary(DatosCompletosCategoricos)

summary(DatosIncompletosCategoricos)
```

- **Salario**: Existe una grán diferencia entre el salario máximo (150000 dólares) y el salario mínimo (20000 dólares). El salario medio es similar en ambos conjuntos de datos:
  - Datos de entrenamiento: 84871 dólares
  - Datos de testeo: 85794 dólares

- **Edad**: La edad media, en ambos conjuntos de datos es de 50 años. Nuestro comprador más joven tiene 20 años mientras que el más longevo tiene una edad de 80 años.

- **Nivel educativo**: Las proporciones de compradores se mantienen en ambos conjuntos de datos:
  - Less than HS: 20%
  - High School: 19.6%
  - Some college:    20%
  - College Degree:  20$  
  - Post College Degree:  20%


```{r}
niv=c(2052,1948,1983,1947,1968)
nivComp=niv/sum(niv)*100
```


```{r}
niv2=c(989,988,1017,1000,1006)
nivComp2=niv2/sum(niv2)*100
```

- **Marca Coche**: Las marcas de coches más frecuentes, en nuestros datos son:
  - Datos de entrenamiento:  Mitsubishi, Subaru, Honda, Buick, Ram y Chrysler
  - Datos de testeo: Toyota, Subary, Nissan, Honda, Kia, Chrysler


- **Código postal**: Las proporciones de compradores se mantienen en ambos conjuntos de datos:
  - Mountain: 13%
  - East South Central: 12.8%
  - Pacific:    12.65%
  - Mid-Atlantic:    12.5%
  - West North Central:  12.4%
  - (Other): 36.5%
  
```{r}
cuenta=c(1155,1135,1112,1108,1087,3216)
propcompleto=cuenta/sum(cuenta)*100
cuenta2= c( 569 ,565  , 560   , 549   , 549 ,1616)
propIncompleto=cuenta2/sum(cuenta2)*100
```

- **Crédito**: De nuevo, en ambos conjuntos de datos, el crédito medio es prácticamente el mismo.
  - Datos de entrenamiento: 249176 dólares
  - Datos de testeo: 249546  dólares

## Resumen según preferencia de marca


```{r}
DatosCompletosCategoricos %>% 
  group_by(Marca) %>% 
  summarise(
  SalarioMedio = mean(salary)  ,
  EdadMedia = age %>% mean() ,
  CreditoMedio = credit %>% mean() ,
) %>% kable(booktabs=TRUE, caption="Resumen estadístico según marca preferida")
```




## Representaciones gráficas



```{r}
DatosMarca = DatosCompletosCategoricos %>% 
  group_by(Marca) %>% 
  count()
```

En esta tabla observamos que existen más clientes que prefieren la marca Sony.


```{r}
ggplot(DatosMarca,aes(x=Marca,y=n,color=Marca))+
  geom_col(fill="white")+
  labs(title="Marca preferida por los clientes",
       y="Número de clientes",x="Marca preferida",
       caption="Fuente: Elaboración propia")
```


### Variables numéricas
#### Marca y edad


```{r}
p<-ggplot(DatosCompletosCategoricos, aes(x=Marca,y=age, color=Marca,group=Marca)) +
  geom_boxplot()+
  stat_summary(fun.y=mean, geom="point", shape=8, size=5, color="black", fill="red") +
  scale_y_continuous(breaks   = seq(0,85,by=5))+
  labs(title="BoxPlot" , subtitle= "Marca vs. Edad", caption="La estrella negra representa el salario medio \n Fuente: Elaboración propia. Conjunto de datos completos")
p
```


Observamos que para ambos grupos, la edad media de los clientes es prácticamente la misma, 50 años.

#### Marca y salario
  

```{r}
p<-ggplot(DatosCompletosCategoricos, aes(x=Marca,y=salary, color=Marca,group=Marca)) +
  geom_boxplot()+
  stat_summary(fun.y=mean, geom="point", shape=8, size=5, color="black", fill="red") +
  scale_y_continuous(breaks   = seq(40000,140000,by=10000))+
  labs(title="BoxPlot" , subtitle= "Marca vs. Salario", caption="La estrella negra representa el valor medio \n Fuente: Elaboración propia. Conjunto de datos completos")
p
```




Observamos que los clientes que prefieren la marca Sony tienen un salario medio más alto que aquellos cuya marca preferia es Acer:

- Salario medio:
  - Clientes que prefieren Acer: 74887.63 dólares
  - Clientes que prefieren Sony: 90944.51	dólares
  
  
#### Marca y crédito  
  
  
```{r}
p<-ggplot(DatosCompletosCategoricos, aes(x=Marca,y=credit, color=Marca,group=Marca)) +
  geom_boxplot()+
  stat_summary(fun.y=mean, geom="point", shape=4, size=5, color="black", fill="red") +
  scale_y_continuous(breaks   = seq(0,500000,by=50000))+
  labs(title="BoxPlot" , subtitle= "Marca vs. Crédito", caption="La estrella negra representa el valor medio \n Fuente: Elaboración propia. Conjunto de datos completos")
p
```
  
En ambos grupos el crédito medio es bastante similar.


### Variables categóricas


#### Marca de coche según marca preferida


```{r}
DatosSonyCoches =DatosCompletosCategoricos %>% 
  filter(Marca=="Sony") %>% 
  group_by(MarcaCoche) %>% 
  count()

DatosAcerCoches =DatosCompletosCategoricos %>% 
  filter(Marca=="Acer") %>% 
  group_by(MarcaCoche) %>% 
  count() 


par(mfrow=c(1,2))

ggplot(DatosSonyCoches,aes(x=reorder(MarcaCoche,n),y=n)) +
  geom_col(fill="lightgreen") +
    labs(title="Marca de coches",
         subtitle="Datos Sony",
       y="Frecuencia",x="Marcas de coche",
       caption="Fuente: Elaboración propia") +
  scale_y_continuous(labels = scales::comma) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))




ggplot(DatosAcerCoches,aes(x=reorder(MarcaCoche,n),y=n)) +
  geom_col(fill="lightgreen") +
    labs(title="Marca de coches",
         subtitle="Datos Acer",
       y="Frecuencia",x="Marcas de coche",
       caption="Fuente: Elaboración propia") +
  scale_y_continuous(labels = scales::comma) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

```

- Para ambos grupos, la marca Mitsubishi está en el top 3 de marcas que usan los clientes.
- Marca preferida:
  - Clientes Sony: Subaru
  - Clientes Acer: Mitsubishi



#### Nivel de educación según marca preferida


```{r}
DatosSonyEducacion =DatosCompletosCategoricos %>% 
  filter(Marca=="Sony") %>% 
  group_by(NivelEduc) %>% 
  count()

DatosAcerEducacion =DatosCompletosCategoricos %>% 
  filter(Marca=="Acer") %>% 
  group_by(NivelEduc) %>% 
  count()

ggplot(DatosSonyEducacion,aes(x=reorder(NivelEduc,n),y=n)) +
  geom_col(fill="lightgreen") +
    labs(title="Nivel de educación",
         subtitle="Datos Sony",
       y="Número de clientes",x="Educación",
       caption="Fuente: Elaboración propia") +
  scale_y_continuous(breaks = seq(0,1600,by=100)) +
  theme(axis.text.x = element_text(angle = 40, hjust = 1))



ggplot(DatosAcerEducacion,aes(x=reorder(NivelEduc,n),y=n)) +
  geom_col(fill="lightgreen") +
    labs(title="Nivel de educación",
         subtitle="Datos Acer",
       y="Número de clientes",x="Educación",
       caption="Fuente: Elaboración propia") +
  scale_y_continuous(breaks = seq(0,1600,by=100)) +
  theme(axis.text.x = element_text(angle = 40, hjust = 1))

par(mfrow=c(1,1))
```




- Para ambos grupos, la mayoría de clientes aún no ha terminado high school. 
- Tambien para ambos grupos, el segundo más frecuente son aquellos individuos que han comenzado la universidad, a continuación aquellos que tienen estudios postuniversitarios
- La diferencia se encuentra: La cuarta clase más frecuente para los clientes que prefieren sony son los que tienen un graduado universidario, y la última para los que únicamente tienen terminado el instituto. Para los cientes de Acer estas dos últimas posiciones son al revés









#### Código postal según marca preferida



```{r}
DatosCP = DatosCompletosCategoricos %>% 
  group_by(Marca,CodigoPostal) %>% 
  count()
```


```{r}
# Interleaved histograms
ggplot(DatosCP, aes(x=CodigoPostal, y=n,color=Marca)) +
  geom_col(fill="white")+
  theme(axis.text.x = element_text(angle = 45, hjust = 1),legend.position="botton")+
  scale_y_continuous(breaks = seq(0,1200,by=100)) +
    labs(title="Código postal",
         subtitle="Según marca preferida",
       y="Número de clientes",x="Código Postal",
       caption="Fuente: Elaboración propia")


```

## Correlación

Como la variable objetivo es binaria, tenemos que estudiar la correlación de otra forma.

```{r}
M = cor(DatosCompletos)
corrplot(M, method = "circle",title = "Matriz de correlación")


# Visualice otros metodos gráficos como, 'circle', 'square', 'ellipse',
# 'number', 'shade', 'color', 'pie',
```

La variable más corrrealda con la variable objetivo, marca de ordenador preferida, es la bariable salario (0.206)


# Modelado y predicción de la marca preferida

## Datos para la predicción de la marca preferida

## Prueba de algoritmos, hiperparámetros y estrategias de optimización para predecir la marca preferida

### Detección de los mejores algoritmos (decision tree classifiers methods):

#### Algoritmo 1: C5.0

##### Hiperparametros alg 2...

##### Balanceo de datos si fuera necesario

#### Algoritmo 2: Random Forest

##### Hiperparametros...

##### Balanceo de datos...

## Validación de los modelos para la predicción de la marca preferida

En este apartado comparamos mediante en Dataset de validación los modelos con todas las estrategias de optimización que hemos decidido aplicar en el apartado anterior.

### Algoritmo 1: C5.0

#### Hiperparametros alg 2...

#### Balanceo de datos si fuera necesario

### Algoritmo 2: Random Forest

#### Hiperparametros...

#### Balanceo de datos...

## Test del modelo final

### Evaluación del modelo final y testeo

### Análisis de error del modelo final

# Predicciones de la marca prefererida

# Conclusiones y recomendaciones

En este apartado exponemos aquellos aspectos interesantes para el negocio que son destacables y que permitan a la dirección establecer estrategias y tomar decisiones.

-   Métodos utilizados para modelar (resultados/métricas obtenidas)
-   Modelo elegido, porqué es el mejor, nivel de confianza de las predicciones
-   Las respuestas previstas a la pregunta de preferencia de marca para las instancias incompletas
-   Gráfico de las preferencias del clientes (comparación de predicción y valor real)

# Encuesta (Survey Questions and Response Key)

## ¿Cuál es su salario anual, sin incluir bonus? (Responder con un valor numérico)

## ¿Edad? (Responder con un valor numérico)

## ¿Cuál es el nivel más alto de educación que ha obtenido?

| Value | Description                               |
|-------|-------------------------------------------|
| 0     | Less than High School Degree              |
| 1     | High School Degree                        |
| 2     | Some College                              |
| 3     | 4-Year College Degree                     |
| 4     | Master's, Doctoral or Professional Degree |

## ¿Cuál es la marca de su coche?

Seleccione una entre las siguientes:

| Value | Description       |
|-------|-------------------|
| 1     | BMW               |
| 2     | Buick             |
| 3     | Cadillac          |
| 4     | Chevrolet         |
| 5     | Chrysler          |
| 6     | Dodge             |
| 7     | Ford              |
| 8     | Honda             |
| 9     | Hyundai           |
| 10    | Jeep              |
| 11    | Kia               |
| 12    | Lincoln           |
| 13    | Mazda             |
| 14    | Mercedes Benz     |
| 15    | Mitsubishi        |
| 16    | Nissan            |
| 17    | Ram               |
| 18    | Subaru            |
| 19    | Toyota            |
| 20    | None of the above |

## Código postal

| Value | Region             |
|-------|--------------------|
| 0     | New England        |
| 1     | Mid-Atlantic       |
| 2     | East North Central |
| 3     | West North Central |
| 4     | South Atlantic     |
| 5     | East South Central |
| 6     | West South Central |
| 7     | Mountain           |
| 8     | Pacific            |

## ¿Qué crédito tiene disponible? (Número)

## ¿Qué marca de ordenador prefiere?

| Value | Region |
|-------|--------|
| 0     | Acer   |
| 1     | Sony   |
